From baefde14550231f6468ac2ed2ed495bc381c0c92 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 7 Jul 2022 19:59:49 +0100
Subject: [PATCH] patch 9.0.0046: reading past end of completion with duplicate
 match

Problem:    Reading past end of completion with duplicate match.
Solution:   Check string length
---
 src/insexpand.c                   |  3 ++-
 src/testdir/test_ins_complete.vim | 10 ++++++++++
 src/version.c                     |  2 ++
 3 files changed, 14 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/insexpand.c
+++ vim-8.2.3995/src/insexpand.c
@@ -686,7 +686,8 @@ ins_compl_add(
 	{
 	    if (!ins_compl_at_original_text(match)
 		    && STRNCMP(match->cp_str, str, len) == 0
-		    && match->cp_str[len] == NUL)
+		    && ((int)STRLEN(match->cp_str) <= len
+						 || match->cp_str[len] == NUL))
 		return NOTDONE;
 	    match = match->cp_next;
 	} while (match != NULL && match != compl_first_match);
--- vim-8.2.3995.orig/src/testdir/test_ins_complete.vim
+++ vim-8.2.3995/src/testdir/test_ins_complete.vim
@@ -1866,5 +1866,15 @@ func Test_infercase_very_long_line()
   set noic noinfercase
 endfunc
 
+func Test_ins_complete_add()
+  " this was reading past the end of allocated memory
+  new
+  norm o
+  norm 7o
+  sil! norm o
+
+  bwipe!
+endfunc
+
 
 " vim: shiftwidth=2 sts=2 expandtab
