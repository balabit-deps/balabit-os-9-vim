From fc68299d436cf87453e432daa77b6d545df4d7ed Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sun, 3 Sep 2023 20:20:52 +0200
Subject: [PATCH] patch 9.0.1857: [security] heap-use-after-free in is_qf_win()

Problem:  heap-use-after-free in is_qf_win()
Solution: Check buffer is valid before accessing it

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/main.c                        |  2 +-
 src/quickfix.c                    |  2 +-
 src/testdir/crash/bt_quickfix_poc |  9 ++++++++
 src/testdir/test_crash.vim        | 34 ++++++++++++++++++++++++-------
 src/version.c                     |  2 ++
 5 files changed, 40 insertions(+), 9 deletions(-)
 create mode 100644 src/testdir/crash/bt_quickfix_poc

--- vim-8.2.3995.orig/src/main.c
+++ vim-8.2.3995/src/main.c
@@ -1579,7 +1579,7 @@ getout(int exitval)
 	    next_tp = tp->tp_next;
 	    FOR_ALL_WINDOWS_IN_TAB(tp, wp)
 	    {
-		if (wp->w_buffer == NULL)
+		if (wp->w_buffer == NULL || !buf_valid(wp->w_buffer))
 		    // Autocmd must have close the buffer already, skip.
 		    continue;
 		buf = wp->w_buffer;
--- vim-8.2.3995.orig/src/quickfix.c
+++ vim-8.2.3995/src/quickfix.c
@@ -4392,7 +4392,7 @@ is_qf_win(win_T *win, qf_info_T *qi)
     // set to NULL.
     // A window displaying a location list buffer will have the w_llist_ref
     // pointing to the location list.
-    if (bt_quickfix(win->w_buffer))
+    if (buf_valid(win->w_buffer) && bt_quickfix(win->w_buffer))
 	if ((IS_QF_STACK(qi) && win->w_llist_ref == NULL)
 		|| (IS_LL_STACK(qi) && win->w_llist_ref == qi))
 	    return TRUE;
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -5057,6 +5057,8 @@ static int included_patches[] =
 /**/
     1855,
 /**/
+    1857,
+/**/
     1854,
 /**/
     1853,
