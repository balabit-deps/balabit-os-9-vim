From 27efc62f5d86afcb2ecb7565587fe8dea4b036fe Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 1 Jul 2022 16:35:45 +0100
Subject: [PATCH] patch 9.0.0018: going over the end of the typahead

Problem:    Going over the end of the typahead.
Solution:   Put a NUL after the typeahead.
---
 src/term.c                   |  1 +
 src/testdir/test_mapping.vim | 10 ++++++++++
 src/version.c                |  2 ++
 3 files changed, 13 insertions(+)

--- vim-8.2.3995.orig/src/term.c
+++ vim-8.2.3995/src/term.c
@@ -5379,6 +5379,7 @@ check_termcode(
 	if (*tp == ESC && !p_ek && (State & INSERT))
 	    continue;
 
+	tp[len] = NUL;
 	key_name[0] = NUL;	// no key name found yet
 	key_name[1] = NUL;	// no key name found yet
 	modifiers = 0;		// no modifiers yet
--- vim-8.2.3995.orig/src/testdir/test_mapping.vim
+++ vim-8.2.3995/src/testdir/test_mapping.vim
@@ -1432,4 +1432,14 @@ func Test_abbreviate_latin1_encoding()
   set encoding=utf-8
 endfunc
 
+func Test_using_past_typeahead()
+  nnoremap :00 0
+  exe "norm :set \x80\xfb0=0\<CR>"
+  exe "sil norm :0\x0f\<C-U>\<CR>"
+
+  exe "norm :set \x80\xfb0=\<CR>"
+  nunmap :00
+endfunc
+
+
 " vim: shiftwidth=2 sts=2 expandtab
