From 51f0bfb88a3554ca2dde777d78a59880d1ee37a8 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Tue, 17 May 2022 20:11:02 +0100
Subject: [PATCH] patch 8.2.4975: recursive command line loop may cause a crash

Problem:    Recursive command line loop may cause a crash.
Solution:   Limit recursion of getcmdline().
---
 src/ex_getln.c               | 12 ++++++++++++
 src/testdir/test_cmdline.vim | 12 ++++++++++++
 src/version.c                |  2 ++
 3 files changed, 26 insertions(+)

--- vim-8.2.3995.orig/src/ex_getln.c
+++ vim-8.2.3995/src/ex_getln.c
@@ -1577,6 +1577,7 @@ getcmdline_int(
     int		indent,		// indent for inside conditionals
     int		clear_ccline)	// clear ccline first
 {
+    static int	depth = 0;	    // call depth
     int		c;
     int		i;
     int		j;
@@ -1607,6 +1608,9 @@ getcmdline_int(
     int		did_save_ccline = FALSE;
     int		cmdline_type;
 
+    // one recursion level deeper
+    ++depth;
+
     if (ccline.cmdbuff != NULL)
     {
 	// Being called recursively.  Since ccline is global, we need to save
@@ -1637,6 +1641,13 @@ getcmdline_int(
     if (init_ccline(firstc, indent) != OK)
 	goto theend;	// out of memory
 
+    if (depth == 50)
+    {
+	// Somehow got into a loop recursively calling getcmdline(), bail out.
+	emsg(_(e_command_too_recursive));
+	goto theend;
+    }
+
     ExpandInit(&xpc);
     ccline.xpc = &xpc;
 
@@ -2504,6 +2515,7 @@ theend:
     {
 	char_u *p = ccline.cmdbuff;
 
+	--depth;
 	if (did_save_ccline)
 	    restore_cmdline(&save_ccline);
 	else
--- vim-8.2.3995.orig/src/testdir/test_cmdline.vim
+++ vim-8.2.3995/src/testdir/test_cmdline.vim
@@ -2003,4 +2003,16 @@ func Test_suffixes_opt()
   call delete('Xfile.o')
 endfunc
 
+func Test_recursive_register()
+  let @= = ''
+  silent! ?e/
+  let caught = 'no'
+  try
+    normal // 
+  catch /E169:/
+    let caught = 'yes'
+  endtry
+  call assert_equal('yes', caught)
+endfunc
+
 " vim: shiftwidth=2 sts=2 expandtab
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -5079,6 +5079,8 @@ static int included_patches[] =
 /**/
     1849,
 /**/
+    4975,
+/**/
     1848,
 /**/
     1847,
