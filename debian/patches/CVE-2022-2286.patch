From f12129f1714f7d2301935bb21d896609bdac221c Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 1 Jul 2022 19:58:30 +0100
Subject: [PATCH] patch 9.0.0020: with some completion reading past end of
 string

Problem:    With some completion reading past end of string.
Solution:   Check the length of the string.
---
 src/insexpand.c                   | 14 ++++++++++++--
 src/testdir/test_ins_complete.vim |  8 ++++++++
 src/version.c                     |  2 ++
 3 files changed, 22 insertions(+), 2 deletions(-)

--- vim-8.2.3995.orig/src/insexpand.c
+++ vim-8.2.3995/src/insexpand.c
@@ -2142,11 +2142,21 @@ ins_compl_stop(int c, int prev_mode, int
     // but only do this, if the Popup is still visible
     if (c == Ctrl_E)
     {
+	char_u *p = NULL;
+
 	ins_compl_delete();
 	if (compl_leader != NULL)
-	    ins_bytes(compl_leader + ins_compl_len());
+	    p = compl_leader;
 	else if (compl_first_match != NULL)
-	    ins_bytes(compl_orig_text + ins_compl_len());
+	    p = compl_orig_text;
+	if (p != NULL)
+	{
+	    int	    compl_len = ins_compl_len();
+	    int	    len = (int)STRLEN(p);
+
+	    if (len > compl_len)
+		ins_bytes_len(p + compl_len, len - compl_len);
+	}
 	retval = TRUE;
     }
 
--- vim-8.2.3995.orig/src/testdir/test_ins_complete.vim
+++ vim-8.2.3995/src/testdir/test_ins_complete.vim
@@ -1885,4 +1885,12 @@ func Test_ins_complete_end_of_line()
   bwipe!
 endfunc
 
+func Test_complete_overrun()
+  " this was going past the end of the copied text
+  new
+  sil norm siÂ”0s0
+  bwipe!
+endfunc
+
+
 " vim: shiftwidth=2 sts=2 expandtab
