From d6c67629ed05aae436164eec474832daf8ba7420 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 24 Aug 2022 20:07:22 +0100
Subject: [PATCH] patch 9.0.0260: using freed memory when using
 'quickfixtextfunc' recursively

Problem:    Using freed memory when using 'quickfixtextfunc' recursively.
Solution:   Do not allow for recursion.
---
 src/quickfix.c                |  9 +++++++++
 src/testdir/test_quickfix.vim | 13 +++++++++++++
 src/version.c                 |  2 ++
 3 files changed, 24 insertions(+)

--- vim-8.2.3995.orig/src/quickfix.c
+++ vim-8.2.3995/src/quickfix.c
@@ -4618,6 +4618,11 @@ call_qftf_func(qf_list_T *qfl, int qf_wi
 {
     callback_T	*cb = &qftf_cb;
     list_T	*qftf_list = NULL;
+    static int	recursive = FALSE;
+
+    if (recursive)
+	return NULL;  // this doesn't work properly recursively
+    recursive = TRUE;
 
     // If 'quickfixtextfunc' is set, then use the user-supplied function to get
     // the text to display. Use the local value of 'quickfixtextfunc' if it is
@@ -4632,7 +4637,10 @@ call_qftf_func(qf_list_T *qfl, int qf_wi
 
 	// create the dict argument
 	if ((d = dict_alloc_lock(VAR_FIXED)) == NULL)
+	{
+	    recursive = FALSE;
 	    return NULL;
+	}
 	dict_add_number(d, "quickfix", (long)IS_QF_LIST(qfl));
 	dict_add_number(d, "winid", (long)qf_winid);
 	dict_add_number(d, "id", (long)qfl->qf_id);
@@ -4655,6 +4663,7 @@ call_qftf_func(qf_list_T *qfl, int qf_wi
 	dict_unref(d);
     }
 
+    recursive = FALSE;
     return qftf_list;
 }
 
--- vim-8.2.3995.orig/src/testdir/test_quickfix.vim
+++ vim-8.2.3995/src/testdir/test_quickfix.vim
@@ -5877,4 +5877,17 @@ func Test_lopen_bwipe_all()
 endfunc
 
 
+func Test_quickfixtextfunc_recursive()
+  func s:QFTfunc(o)
+    cgete '0'
+  endfunc
+  copen
+  let &quickfixtextfunc = 's:QFTfunc'
+  cex ""
+
+  let &quickfixtextfunc = ''
+  cclose
+endfunc
+
+
 " vim: shiftwidth=2 sts=2 expandtab
