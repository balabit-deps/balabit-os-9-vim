From d25f003342aca9889067f2e839963dfeccf1fe05 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 30 Jun 2022 12:30:19 +0100
Subject: [PATCH] patch 9.0.0011: reading beyond the end of the line with put
 command

Problem:    Reading beyond the end of the line with put command.
Solution:   Adjust the end mark position.
---
 src/register.c           |  2 ++
 src/testdir/test_put.vim | 12 ++++++++++++
 src/version.c            |  2 ++
 3 files changed, 16 insertions(+)

--- vim-8.2.3995.orig/src/register.c
+++ vim-8.2.3995/src/register.c
@@ -1906,6 +1906,8 @@ do_put(
 		    vim_memset(ptr, ' ', (size_t)spaces);
 		    ptr += spaces;
 		}
+		else
+		    totlen -= spaces;  // didn't use these spaces
 	    }
 
 	    // may insert some spaces after the new text
--- vim-8.2.3995.orig/src/testdir/test_put.vim
+++ vim-8.2.3995/src/testdir/test_put.vim
@@ -221,5 +221,17 @@ func Test_put_visual_block_mode()
   set ve=
 endfunc
 
+" this was putting the end mark after the end of the line
+func Test_put_visual_mode()
+  edit! SomeNewBuffer
+  set selection=exclusive
+  exe "norm o\t"
+  m0
+  sil! norm pp
+
+  bwipe!
+  set selection&
+endfunc
+
 
 " vim: shiftwidth=2 sts=2 expandtab
