From 8eba2bd291b347e3008aa9e565652d51ad638cfa Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 22 Jun 2022 19:59:28 +0100
Subject: [PATCH] patch 8.2.5151: reading beyond the end of the line with lisp
 indenting

Problem:    Reading beyond the end of the line with lisp indenting.
Solution:   Avoid going over the NUL at the end of the line.
---
 src/indent.c                   |  7 +++++--
 src/testdir/test_lispwords.vim | 12 +++++++++++-
 src/version.c                  |  2 ++
 3 files changed, 18 insertions(+), 3 deletions(-)

--- vim-8.2.3995.orig/src/indent.c
+++ vim-8.2.3995/src/indent.c
@@ -2004,8 +2004,11 @@ get_lisp_indent(void)
 		    amount += 2;
 		else
 		{
-		    that++;
-		    amount++;
+		    if (*that != NUL)
+		    {
+			that++;
+			amount++;
+		    }
 		    firsttry = amount;
 
 		    while (VIM_ISWHITE(*that))
--- vim-8.2.3995.orig/src/testdir/test_lispwords.vim
+++ vim-8.2.3995/src/testdir/test_lispwords.vim
@@ -1,4 +1,5 @@
-" Tests for 'lispwords' settings being global-local
+" Tests for 'lispwords' settings being global-local.
+" And  other lisp indent stuff.
 
 set nocompatible viminfo+=nviminfo
 
@@ -85,4 +86,13 @@ func Test_lisp_indent()
   set nolisp
 endfunc
 
+func Test_lisp_indent_works()
+  " This was reading beyond the end of the line
+  new
+  exe "norm a\t√º(\<CR>="
+  set lisp
+  norm ==
+  bwipe!
+endfunc
+
 " vim: shiftwidth=2 sts=2 expandtab
