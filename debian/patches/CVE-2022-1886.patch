From 2a585c85013be22f59f184d49612074fd9b115d7 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 25 May 2022 15:15:38 +0100
Subject: [PATCH] patch 8.2.5016: access before start of text with a put
 command

Problem:    Access before start of text with a put command.
Solution:   Check the length is more than zero.
---
 src/register.c           | 7 +++++--
 src/testdir/test_put.vim | 9 +++++++++
 src/version.c            | 2 ++
 3 files changed, 16 insertions(+), 2 deletions(-)

--- vim-8.2.3995.orig/src/register.c
+++ vim-8.2.3995/src/register.c
@@ -2213,9 +2213,12 @@ error:
 	    len = STRLEN(y_array[y_size - 1]);
 	    col = (colnr_T)len - lendiff;
 	    if (col > 1)
-		curbuf->b_op_end.col = col - 1
-				- mb_head_off(y_array[y_size - 1],
+	    {
+		curbuf->b_op_end.col = col - 1;
+		if (len > 0)
+		    curbuf->b_op_end.col -= mb_head_off(y_array[y_size - 1],
 						y_array[y_size - 1] + len - 1);
+	    }
 	    else
 		curbuf->b_op_end.col = 0;
 
--- vim-8.2.3995.orig/src/testdir/test_put.vim
+++ vim-8.2.3995/src/testdir/test_put.vim
@@ -233,5 +233,14 @@ func Test_put_visual_mode()
   set selection&
 endfunc
 
+" this was putting a mark before the start of a line
+func Test_put_empty_register()
+  new
+  norm yy
+  norm [Pi00ggv)s0
+  sil! norm [P
+  bwipe!
+endfunc
+
 
 " vim: shiftwidth=2 sts=2 expandtab
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -5079,6 +5079,8 @@ static int included_patches[] =
 /**/
     1849,
 /**/
+    5016,
+/**/
     4975,
 /**/
     1848,
