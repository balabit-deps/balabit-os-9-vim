From cd38bb4d83c942c4bad596835c6766cbf32e5195 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sun, 26 Jun 2022 14:04:07 +0100
Subject: [PATCH] patch 8.2.5163: crash when deleting buffers in diff mode

Problem:    Crash when deleting buffers in diff mode.
Solution:   Recompute diffs later.  Skip window without a valid buffer.
---
 src/diff.c                    | 10 ++++++++--
 src/testdir/test_diffmode.vim | 12 ++++++++++++
 src/version.c                 |  2 ++
 3 files changed, 22 insertions(+), 2 deletions(-)

--- vim-8.2.3995.orig/src/diff.c
+++ vim-8.2.3995/src/diff.c
@@ -119,7 +119,12 @@ diff_buf_delete(buf_T *buf)
 	    tp->tp_diffbuf[i] = NULL;
 	    tp->tp_diff_invalid = TRUE;
 	    if (tp == curtab)
-		diff_redraw(TRUE);
+	    {
+		// don't redraw right away, more might change or buffer state
+		// is invalid right now
+		need_diff_redraw = TRUE;
+		redraw_later(VALID);
+	    }
 	}
     }
 }
@@ -670,7 +675,8 @@ diff_redraw(
 
     need_diff_redraw = FALSE;
     FOR_ALL_WINDOWS(wp)
-	if (wp->w_p_diff)
+	// when closing windows or wiping buffers skip invalid window
+	if (wp->w_p_diff && buf_valid(wp->w_buffer))
 	{
 	    redraw_win_later(wp, SOME_VALID);
 	    if (wp != curwin)
--- vim-8.2.3995.orig/src/testdir/test_diffmode.vim
+++ vim-8.2.3995/src/testdir/test_diffmode.vim
@@ -1462,4 +1462,17 @@ func Test_diff_binary()
   set diffopt&vim
 endfunc
 
+" This was trying to update diffs for a buffer being closed
+func Test_diff_only()
+  silent! lfile
+  set diff
+  lopen
+  norm ␗␘␗␎o
+  silent! norm ␗␎␗o
+
+  set nodiff
+  %bwipe!
+endfunc
+
+
 " vim: shiftwidth=2 sts=2 expandtab
