From 8279af514ca7e5fd3c31cf13b0864163d1a0bfeb Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 26 Sep 2022 23:08:22 +0100
Subject: [PATCH] patch 9.0.0598: using negative array index with negative
 width window

Problem:    Using negative array index with negative width window.
Solution:   Make sure the window width does not become negative.
---
 src/testdir/test_cmdwin.vim | 22 ++++++++++++++++++++++
 src/version.c               |  2 ++
 src/window.c                |  5 ++++-
 3 files changed, 28 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/window.c
+++ vim-8.2.3995/src/window.c
@@ -2090,6 +2090,8 @@ win_equal_rec(
 		if (hnc)	    // add next_curwin size
 		{
 		    next_curwin_size -= p_wiw - (m - n);
+		    if (next_curwin_size < 0)
+			next_curwin_size = 0;
 		    new_size += next_curwin_size;
 		    room -= new_size - next_curwin_size;
 		}
@@ -6438,7 +6440,8 @@ scroll_to_fraction(win_T *wp, int prev_h
     void
 win_new_width(win_T *wp, int width)
 {
-    wp->w_width = width;
+    // Should we give an error if width < 0?
+    wp->w_width = width < 0 ? 0 : width;
     wp->w_lines_valid = 0;
     changed_line_abv_curs_win(wp);
     invalidate_botline_win(wp);
