From fe6fb267e6ee5c5da2f41889e4e0e0ac5bf4b89d Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 24 Jan 2022 18:16:12 +0000
Subject: [PATCH] patch 8.2.4206: condition with many "(" causes a crash

Problem:    Condition with many "(" causes a crash.
Solution:   Limit recursion to 1000.
---
 src/errors.h                    |  7 ++++++-
 src/eval.c                      | 12 ++++++++++++
 src/testdir/test_eval_stuff.vim |  5 +++++
 src/version.c                   |  2 ++
 4 files changed, 25 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/eval.c
+++ vim-8.2.3995/src/eval.c
@@ -3424,6 +3424,7 @@ eval7(
     char_u	*start_leader, *end_leader;
     int		ret = OK;
     char_u	*alias;
+    static	int recurse = 0;
 
     /*
      * Initialise variable so that clear_tv() can't mistake this for a
@@ -3450,6 +3451,15 @@ eval7(
 	return FAIL;
     }
 
+    // Limit recursion to 1000 levels.  At least at 10000 we run out of stack
+    // and crash.
+    if (recurse == 1000)
+    {
+	
+	return FAIL;
+    }
+    ++recurse;
+
     switch (**arg)
     {
     /*
@@ -3676,6 +3686,8 @@ eval7(
      */
     if (ret == OK && evaluate && end_leader > start_leader)
 	ret = eval7_leader(rettv, FALSE, start_leader, &end_leader);
+
+    --recurse;
     return ret;
 }
 
