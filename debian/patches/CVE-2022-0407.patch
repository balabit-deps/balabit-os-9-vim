[Ubuntu note: Removed changes made to version.c because they were not needed
 to fix the vulnerability.
 -- Evan Caville <evan.caville@canonical.com>]

From 44db8213d38c39877d2148eff6a72f4beccfb94e Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Tue, 25 Jan 2022 21:26:17 +0000
Subject: [PATCH] patch 8.2.4219: reading before the start of the line

Problem:    Reading before the start of the line.
Solution:   Check boundary before trying to read the character.
---
 src/register.c              | 2 +-
 src/testdir/test_visual.vim | 7 +++++++
 src/version.c               | 2 ++
 3 files changed, 10 insertions(+), 1 deletion(-)

--- a/src/register.c
+++ b/src/register.c
@@ -1462,7 +1462,7 @@
     {
 	int s = bd->textlen + bd->endspaces;
 
-	while (VIM_ISWHITE(*(bd->textstart + s - 1)) && s > 0)
+	while (s > 0 && VIM_ISWHITE(*(bd->textstart + s - 1)))
 	{
 	    s = s - (*mb_head_off)(bd->textstart, bd->textstart + s - 1) - 1;
 	    pnew--;
--- a/src/testdir/test_visual.vim
+++ b/src/testdir/test_visual.vim
@@ -1247,6 +1247,13 @@
   bw!
 endfunc
 
+func Test_visual_block_yank_zy()
+  new
+  " this was reading before the start of the line
+  exe "norm o\<C-T>\<Esc>\<C-V>zy"
+  bwipe!
+endfunc
+
 func Test_visual_block_with_virtualedit()
   CheckScreendump
 
