From 1e56bda9048a9625bce6e660938c834c5c15b07d Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 29 Jul 2022 15:28:27 +0100
Subject: [PATCH] patch 9.0.0104: going beyond allocated memory when evaluating
 string constant

Problem:    Going beyond allocated memory when evaluating string constant.
Solution:   Properly skip over <Key> form.
---
 src/testdir/test_eval_stuff.vim |  5 +++++
 src/typval.c                    | 12 ++++++++++++
 src/version.c                   |  2 ++
 3 files changed, 19 insertions(+)

--- vim-8.2.3995.orig/src/typval.c
+++ vim-8.2.3995/src/typval.c
@@ -1985,7 +1985,19 @@ eval_string(char_u **arg, typval_T *rett
 	    // reserve space for 18 extra.
 	    // Each byte in the char could be encoded as K_SPECIAL K_EXTRA x.
 	    if (*p == '<')
+	    {
+		int		modifiers = 0;
+		int		flags = FSK_KEYCODE | FSK_IN_STRING;
+
 		extra += 18;
+
+		// Skip to the '>' to avoid using '{' inside for string
+		// interpolation.
+		if (p[1] != '*')
+		    flags |= FSK_SIMPLIFY;
+		if (find_special_key(&p, &modifiers, flags, NULL) != 0)
+		    --p;  // leave "p" on the ">"
+	    }
 	}
     }
 
