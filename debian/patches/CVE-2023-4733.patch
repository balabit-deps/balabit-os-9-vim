From e1dc9a627536304bc4f738c21e909ad9fcf3974c Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sat, 2 Sep 2023 14:40:13 +0200
Subject: [PATCH] patch 9.0.1840: [security] use-after-free in do_ecmd

Problem:  use-after-free in do_ecmd
Solution: Verify oldwin pointer after reset_VIsual()

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/ex_cmds.c                        |  14 ++++++++++----
 src/testdir/Make_all.mak             |   2 ++
 src/testdir/crash/poc_huaf1          | Bin 0 -> 1541 bytes
 src/testdir/crash/poc_huaf2          | Bin 0 -> 3238 bytes
 src/testdir/crash/poc_huaf3          | Bin 0 -> 4053 bytes
 src/testdir/dumps/Test_crash_01.dump |  20 ++++++++++++++++++++
 src/testdir/test_crash.vim           |  25 +++++++++++++++++++++++++
 src/version.c                        |   2 ++
 8 files changed, 59 insertions(+), 4 deletions(-)
 create mode 100644 src/testdir/crash/poc_huaf1
 create mode 100644 src/testdir/crash/poc_huaf2
 create mode 100644 src/testdir/crash/poc_huaf3
 create mode 100644 src/testdir/dumps/Test_crash_01.dump
 create mode 100644 src/testdir/test_crash.vim

--- vim-8.2.3995.orig/src/ex_cmds.c
+++ vim-8.2.3995/src/ex_cmds.c
@@ -2611,12 +2611,18 @@ do_ecmd(
 	goto theend;
     }
 
-    /*
-     * End Visual mode before switching to another buffer, so the text can be
-     * copied into the GUI selection buffer.
-     */
+    
+     // End Visual mode before switching to another buffer, so the text can be
+     // copied into the GUI selection buffer.
+     // Careful: may trigger ModeChanged() autocommand
+     
+    // Should we block autocommands here?
     reset_VIsual();
 
+    // autocommands freed window :(
+    if (oldwin != NULL && !win_valid(oldwin))
+	oldwin = NULL;
+
 #if defined(FEAT_EVAL)
     if ((command != NULL || newlnum > (linenr_T)0)
 	    && *get_vim_var_str(VV_SWAPCOMMAND) == NUL)
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -751,6 +751,8 @@ static char *(features[]) =
 static int included_patches[] =
 {   /* Add new patch number below this line */
 /**/
+    1840,
+/**/
     213,
 /**/
     4919,
