From 20d161ace307e28690229b68584f2d84556f8960 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Thu, 5 Oct 2023 22:08:30 +0200
Subject: [PATCH] patch 9.0.1992: [security] segfault in exmode

Problem:  segfault in exmode when redrawing
Solution: skip gui_scroll when exmode_active

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/gui.c                         | 4 ++++
 src/testdir/crash/crash_scrollbar | 2 ++
 src/testdir/test_crash.vim        | 7 +++++++
 src/version.c                     | 2 ++
 4 files changed, 15 insertions(+)
 create mode 100644 src/testdir/crash/crash_scrollbar

--- vim-8.2.3995.orig/src/gui.c
+++ vim-8.2.3995/src/gui.c
@@ -4465,6 +4465,7 @@ gui_do_scrollbar(
  * Scroll a window according to the values set in the globals current_scrollbar
  * and scrollbar_value.  Return TRUE if the cursor in the current window moved
  * or FALSE otherwise.
+ * may eventually cause a redraw using updateWindow
  */
     int
 gui_do_scroll(void)
@@ -4484,6 +4485,9 @@ gui_do_scroll(void)
     if (wp == NULL)
 	// Couldn't find window
 	return FALSE;
+    // don't redraw, LineOffset and similar are not valid!
+    if (exmode_active)
+	return FALSE;
 
     /*
      * Compute number of lines to scroll.  If zero, nothing to do.
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -4825,6 +4825,8 @@ static int included_patches[] =
 /**/
     1970,
 /**/
+    1992,
+/**/
     1969,
 /**/
     1968,
