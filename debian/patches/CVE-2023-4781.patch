From f6d28fe2c95c678cc3202cc5dc825a3fcc709e93 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Tue, 5 Sep 2023 20:18:06 +0200
Subject: [PATCH] patch 9.0.1873: [security] heap-buffer-overflow in
 vim_regsub_both

Problem:  heap-buffer-overflow in vim_regsub_both
Solution: Disallow exchanging windows when textlock is active

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/ex_cmds.c                         |   3 +++
 src/testdir/crash/vim_regsub_both_poc | Bin 0 -> 244 bytes
 src/testdir/test_crash.vim            |   9 +++++++++
 src/version.c                         |   2 ++
 src/window.c                          |   5 +++++
 5 files changed, 19 insertions(+)
 create mode 100644 src/testdir/crash/vim_regsub_both_poc

--- vim-8.2.3995.orig/src/ex_cmds.c
+++ vim-8.2.3995/src/ex_cmds.c
@@ -4455,6 +4455,9 @@ ex_substitute(exarg_T *eap)
 		{
 		    nmatch = curbuf->b_ml.ml_line_count - sub_firstlnum + 1;
 		    skip_match = TRUE;
+		    // safety check
+		    if (nmatch < 0)
+			goto skip;
 		}
 
 		// Need room for:
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -5049,6 +5049,8 @@ static int included_patches[] =
 /**/
     1860,
 /**/
+    1873,
+/**/
     1859,
 /**/
     1858,
--- vim-8.2.3995.orig/src/window.c
+++ vim-8.2.3995/src/window.c
@@ -1739,6 +1739,11 @@ win_rotate(int upwards, int count)
 	beep_flush();
 	return;
     }
+    if (text_or_buf_locked())
+    {
+	beep_flush();
+	return;
+    }
 
 #ifdef FEAT_GUI
     need_mouse_correct = TRUE;
