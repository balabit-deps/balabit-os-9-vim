From f7c7c3fad6d2135d558f3b36d0d1a943118aeb5e Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 22 Jun 2022 19:08:38 +0100
Subject: [PATCH] patch 8.2.5150: read past the end of the first line with
 ":0;'{"

Problem:    Read past the end of the first line with ":0;'{".
Solution:   When on line zero check the column is valid for line one.
---
 src/ex_docmd.c               | 5 ++++-
 src/testdir/test_cmdline.vim | 8 ++++++++
 src/version.c                | 2 ++
 3 files changed, 14 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/ex_docmd.c
+++ vim-8.2.3995/src/ex_docmd.c
@@ -3348,10 +3348,13 @@ parse_cmd_address(exarg_T *eap, char **e
 		curwin->w_cursor.lnum = eap->line2;
 
 		// Don't leave the cursor on an illegal line or column, but do
-		// accept zero as address, so 0;/PATTERN/ works correctly.
+		// accept zero as address, so 0;/PATTERN/ works correctly
+		// (where zero usually means to use the first line).
 		// Check the cursor position before returning.
 		if (eap->line2 > 0)
 		    check_cursor();
+		else
+		    check_cursor_col();
 		need_check_cursor = TRUE;
 	    }
 	}
--- vim-8.2.3995.orig/src/testdir/test_cmdline.vim
+++ vim-8.2.3995/src/testdir/test_cmdline.vim
@@ -667,6 +667,14 @@ func Test_illegal_address2()
   call delete('Xtest.vim')
 endfunc
 
+func Test_mark_from_line_zero()
+  " this was reading past the end of the first (empty) line
+  new
+  norm oxxxx
+  call assert_fails("0;'(", 'E20:')
+  bwipe!
+endfunc
+
 func Test_cmdline_complete_wildoptions()
   help
   call feedkeys(":tag /\<c-a>\<c-b>\"\<cr>", 'tx')
