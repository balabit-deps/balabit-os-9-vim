From d1d8f6bacb489036d0fd479c9dd3c0102c988889 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Sun, 14 Aug 2022 21:28:32 +0100
Subject: [PATCH] patch 9.0.0211: invalid memory access when compiling :lockvar

Problem:    Invalid memory access when compiling :lockvar.
Solution:   Don't read past the end of the line.
---
 src/testdir/test_vim9_cmd.vim | 9 +++++++++
 src/version.c                 | 2 ++
 src/vim9cmds.c                | 9 +++++++--
 3 files changed, 18 insertions(+), 2 deletions(-)

--- vim-8.2.3995.orig/src/vim9cmds.c
+++ vim-8.2.3995/src/vim9cmds.c
@@ -194,10 +194,17 @@ compile_lock_unlock(
     size_t	len;
     char_u	*buf;
     isntype_T	isn = ISN_EXEC;
+    char	*cmd = eap->cmdidx == CMD_lockvar ? "lockvar" : "unlockvar";
 
     if (cctx->ctx_skip == SKIP_YES)
 	return OK;
 
+    if (*p == NUL)
+    {
+	semsg(_(e_argument_required_for_str), cmd);
+	return FAIL;
+    }
+
     // Cannot use :lockvar and :unlockvar on local variables.
     if (p[1] != ':')
     {
@@ -229,9 +236,7 @@ compile_lock_unlock(
 	ret = FAIL;
     else
     {
-	vim_snprintf((char *)buf, len, "%s %s",
-		eap->cmdidx == CMD_lockvar ? "lockvar" : "unlockvar",
-		p);
+	vim_snprintf((char *)buf, len, "%s %s", cmd, p);
 	ret = generate_EXEC_copy(cctx, isn, buf);
 
 	vim_free(buf);
