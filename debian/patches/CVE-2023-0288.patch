From 232bdaaca98c34a99ffadf27bf6ee08be6cc8f6a Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 13 Jan 2023 14:17:58 +0000
Subject: [PATCH] patch 9.0.1189: invalid memory access with folding and using
 "L"

Problem:    Invalid memory access with folding and using "L".
Solution:   Prevent the cursor from moving to line zero.
---
 src/normal.c              | 3 ++-
 src/testdir/test_fold.vim | 8 ++++++++
 src/version.c             | 2 ++
 3 files changed, 12 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/normal.c
+++ vim-8.2.3995/src/normal.c
@@ -3972,7 +3972,8 @@ nv_scroll(cmdarg_T *cap)
 		{
 		    (void)hasFolding(curwin->w_cursor.lnum,
 						&curwin->w_cursor.lnum, NULL);
-		    --curwin->w_cursor.lnum;
+		    if (curwin->w_cursor.lnum > curwin->w_topline)
+			--curwin->w_cursor.lnum;
 		}
 	    }
 	    else
--- vim-8.2.3995.orig/src/testdir/test_fold.vim
+++ vim-8.2.3995/src/testdir/test_fold.vim
@@ -1439,4 +1439,12 @@ func Test_foldtext_scriptlocal_func()
   delfunc s:FoldText
 endfunc
 
+func Test_indent_with_L_command()
+  " The "L" command moved the cursor to line zero, causing the text saved for
+  " undo to use line number -1, which caused trouble for undo later.
+  new
+  sil! norm 8RV{zf8=Lu
+  bwipe!
+endfunc
+
 " vim: shiftwidth=2 sts=2 expandtab
