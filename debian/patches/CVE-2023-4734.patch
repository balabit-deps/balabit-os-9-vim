From 4c6fe2e2ea62469642ed1d80b16d39e616b25cf5 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sat, 2 Sep 2023 19:30:03 +0200
Subject: [PATCH] patch 9.0.1846: [security] crash in fullcommand

Problem:  crash in fullcommand
Solution: Check for typeval correctly

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/ex_docmd.c                 | 2 +-
 src/testdir/test_functions.vim | 5 +++++
 src/version.c                  | 2 ++
 3 files changed, 8 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/ex_docmd.c
+++ vim-8.2.3995/src/ex_docmd.c
@@ -3909,7 +3909,7 @@ f_fullcommand(typval_T *argvars, typval_
     if (in_vim9script() && check_for_string_arg(argvars, 0) == FAIL)
 	return;
 
-    name = argvars[0].vval.v_string;
+    name = tv_get_string(&argvars[0]);
     if (name == NULL)
 	return;
 
--- vim-8.2.3995.orig/src/testdir/test_functions.vim
+++ vim-8.2.3995/src/testdir/test_functions.vim
@@ -2783,4 +2783,9 @@ func Test_funcref_to_string()
 endfunc
 
 
+func Test_fullcommand()
+  " this used to crash vim
+  call assert_equal('', fullcommand(10))
+endfunc
+
 " vim: shiftwidth=2 sts=2 expandtab
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -751,6 +751,8 @@ static char *(features[]) =
 static int included_patches[] =
 {   /* Add new patch number below this line */
 /**/
+    1846,
+/**/
     1840,
 /**/
     213,
