From 4f1b083be43f351bc107541e7b0c9655a5d2c0bb Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 29 Aug 2022 20:45:16 +0100
Subject: [PATCH] patch 9.0.0322: crash when no errors and 'quickfixtextfunc'
 is set

Problem:    Crash when no errors and 'quickfixtextfunc' is set.
Solution:   Do not handle errors if there aren't any.
---
 src/quickfix.c                |  2 +-
 src/testdir/test_quickfix.vim | 16 ++++++++++++++++
 src/version.c                 |  2 ++
 3 files changed, 19 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/quickfix.c
+++ vim-8.2.3995/src/quickfix.c
@@ -4705,7 +4705,7 @@ qf_fill_buffer(qf_list_T *qfl, buf_T *bu
     }
 
     // Check if there is anything to display
-    if (qfl != NULL)
+    if (qfl != NULL && qfl->qf_start != NULL)
     {
 	char_u		dirname[MAXPATHL];
 	int		invalid_val = FALSE;
--- vim-8.2.3995.orig/src/testdir/test_quickfix.vim
+++ vim-8.2.3995/src/testdir/test_quickfix.vim
@@ -3790,6 +3790,22 @@ func Xgetlist_empty_tests(cchar)
   endif
 endfunc
 
+func Test_empty_list_quickfixtextfunc()
+  " This was crashing.  Can only reproduce by running it in a separate Vim
+  " instance.
+  let lines =<< trim END
+      func s:Func(o)
+              cgetexpr '0'
+      endfunc
+      cope
+      let &quickfixtextfunc = 's:Func'
+      cgetfile [ex
+  END
+  call writefile(lines, 'Xquickfixtextfunc')
+  call RunVim([], [], '-e -s -S Xquickfixtextfunc -c qa')
+  call delete('Xquickfixtextfunc')
+endfunc
+
 func Test_getqflist()
   call Xgetlist_empty_tests('c')
   call Xgetlist_empty_tests('l')
