[Ubuntu note: Removed changes made to version.c because they were not needed
 to fix the vulnerability.
 -- Evan Caville <evan.caville@canonical.com>]

From a4bc2dd7cccf5a4a9f78b58b6f35a45d17164323 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Thu, 27 Jan 2022 19:27:16 +0000
Subject: [PATCH] patch 8.2.4233: crash when recording and using Select mode

Problem:    Crash when recording and using Select mode.
Solution:   When deleting the last recorded character check there is something
            to delete.
---
 src/getchar.c                  | 5 ++++-
 src/testdir/test_registers.vim | 9 +++++++++
 src/version.c                  | 2 ++
 3 files changed, 15 insertions(+), 1 deletion(-)

--- a/src/getchar.c
+++ b/src/getchar.c
@@ -248,8 +248,11 @@
     static void
 delete_buff_tail(buffheader_T *buf, int slen)
 {
-    int len = (int)STRLEN(buf->bh_curr->b_str);
+    int len;
 
+    if (buf->bh_curr == NULL || buf->bh_curr->b_str == NULL)
+	return;  // nothing to delete
+    len = (int)STRLEN(buf->bh_curr->b_str);
     if (len >= slen)
     {
 	buf->bh_curr->b_str[len - slen] = NUL;
--- a/src/testdir/test_registers.vim
+++ b/src/testdir/test_registers.vim
@@ -756,6 +756,15 @@
   call RunVim([], [], '-u NONE -i NONE -e -s -S XTest_zero_y_append -c qa\!')
 endfunc
 
+func Test_record_in_select_mode()
+  new
+  call setline(1, 'text')
+  sil norm q00
+  sil norm q
+  call assert_equal('0ext', getline(1))
+  bwipe!
+endfunc
+
 " Make sure that y_append is correctly reset
 " and the previous register is working as expected
 func Test_register_y_append_reset()
