From 78d52883e10d71f23ab72a3d8b9733b00da8c9ad Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Tue, 24 May 2022 13:57:54 +0100
Subject: [PATCH] patch 8.2.5013: after text formatting cursor may be in an
 invalid position

Problem:    After text formatting the cursor may be in an invalid position.
Solution:   Correct the cursor position after formatting.
---
 src/testdir/test_textformat.vim | 12 ++++++++++++
 src/textformat.c                |  3 +++
 src/version.c                   |  2 ++
 3 files changed, 17 insertions(+)

--- vim-8.2.3995.orig/src/testdir/test_textformat.vim
+++ vim-8.2.3995/src/testdir/test_textformat.vim
@@ -1211,4 +1211,16 @@ func Test_fo_2()
   close!
 endfunc
 
+" This was leaving the cursor after the end of a line.  Complicated way to
+" have the problem show up with valgrind.
+func Test_correct_cursor_position()
+  set encoding=iso8859
+  new
+  norm a000Â“0
+  sil! norm gggg0i0gw0gg
+
+  bwipe!
+  set encoding=utf8
+endfunc
+
 " vim: shiftwidth=2 sts=2 expandtab
--- vim-8.2.3995.orig/src/textformat.c
+++ vim-8.2.3995/src/textformat.c
@@ -863,6 +863,9 @@ op_format(
     {
 	curwin->w_cursor = saved_cursor;
 	saved_cursor.lnum = 0;
+
+	// formatting may have made the cursor position invalid
+	check_cursor();
     }
 
     if (oap->is_VIsual)
