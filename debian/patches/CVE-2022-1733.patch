From 60ae0e71490c97f2871a6344aca61cacf220f813 Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Mon, 16 May 2022 18:06:15 +0100
Subject: [PATCH] patch 8.2.4968: reading past end of the line when C-indenting

Problem:    Reading past end of the line when C-indenting.
Solution:   Check for NUL.
---
 src/cindent.c                | 2 +-
 src/testdir/test_cindent.vim | 7 +++++++
 src/version.c                | 2 ++
 3 files changed, 10 insertions(+), 1 deletion(-)

--- vim-8.2.3995.orig/src/cindent.c
+++ vim-8.2.3995/src/cindent.c
@@ -89,7 +89,7 @@ skip_string(char_u *p)
 		while (vim_isdigit(p[i - 1]))   // '\000'
 		    ++i;
 	    }
-	    if (p[i] == '\'')		    // check for trailing '
+	    if (p[i - 1] != NUL && p[i] == '\'')    // check for trailing '
 	    {
 		p += i;
 		continue;
--- vim-8.2.3995.orig/src/testdir/test_cindent.vim
+++ vim-8.2.3995/src/testdir/test_cindent.vim
@@ -5319,6 +5319,13 @@ func Test_cindent_change_multline()
   close!
 endfunc
 
+" This was reading past the end of the line
+func Test_cindent_check_funcdecl()
+  new
+  sil norm o0␏('\0␏=L
+  bwipe!
+endfunc
+
 func Test_cindent_pragma()
   new
   setl cindent ts=4 sw=4
