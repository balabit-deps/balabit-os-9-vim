Backport of:

From c0f0e2380e5954f4a52a131bf6b8499838ad1dae Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sun, 16 Feb 2025 16:06:38 +0100
Subject: [PATCH] patch 9.1.1115: [security]: use-after-free in str_to_reg()

Problem:  [security]: use-after-free in str_to_reg()
          (fizz-is-on-the-way)
Solution: when redirecting the :display command, check that one
          does not output to the register being displayed

Github Advisory:
https://github.com/vim/vim/security/advisories/GHSA-63p5-mwg2-787v

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/register.c                 |  3 ++-
 src/testdir/test_registers.vim | 20 ++++++++++++++++++++
 src/version.c                  |  2 ++
 3 files changed, 24 insertions(+), 1 deletion(-)

Index: vim-8.2.3995/src/register.c
===================================================================
--- vim-8.2.3995.orig/src/register.c
+++ vim-8.2.3995/src/register.c
@@ -2395,7 +2395,8 @@ ex_display(exarg_T *eap)
 
 #ifdef FEAT_EVAL
 	if (name == MB_TOLOWER(redir_reg)
-		|| (redir_reg == '"' && yb == y_previous))
+		|| (vim_strchr((char_u *)"\"*+", redir_reg) != NULL &&
+		    (yb == y_previous || yb == &y_regs[0])))
 	    continue;	    // do not list register being written to, the
 			    // pointer can be freed
 #endif
