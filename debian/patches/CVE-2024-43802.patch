Description: heap-buffer-overflow in ins_typebuf
 Problem:  heap-buffer-overflow in ins_typebuf
           (SuyueGuo)
 Solution: When flushing the typeahead buffer, validate that there
           is enough space left
Author: Christian Brabandt <cb@256bit.org>
Origin: upstream, https://github.com/vim/vim/commit/322ba9108612bead5eb
---

Index: vim-8.2.3995/src/getchar.c
===================================================================
--- vim-8.2.3995.orig/src/getchar.c
+++ vim-8.2.3995/src/getchar.c
@@ -432,9 +432,18 @@ flush_buffers(flush_buffers_T flush_type
 
     if (flush_typeahead == FLUSH_MINIMAL)
     {
-	// remove mapped characters at the start only
-	typebuf.tb_off += typebuf.tb_maplen;
-	typebuf.tb_len -= typebuf.tb_maplen;
+	// remove mapped characters at the start only,
+	// but only when enough space left in typebuf
+	if (typebuf.tb_off + typebuf.tb_maplen >= typebuf.tb_buflen)
+	{
+	    typebuf.tb_off = MAXMAPLEN;
+	    typebuf.tb_len = 0;
+	}
+	else
+	{
+	    typebuf.tb_off += typebuf.tb_maplen;
+	    typebuf.tb_len -= typebuf.tb_maplen;
+	}
 #if defined(FEAT_CLIENTSERVER) || defined(FEAT_EVAL)
 	if (typebuf.tb_len == 0)
 	    typebuf_was_filled = FALSE;
