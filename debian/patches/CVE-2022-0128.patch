[Ubuntu note: Removed changes made to version.c because they were not needed
 to fix the vulnerability.
 -- Evan Caville <evan.caville@canonical.com>]

From d3a117814d6acbf0dca3eff1a7626843b9b3734a Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Wed, 5 Jan 2022 16:50:40 +0000
Subject: [PATCH] patch 8.2.4009: reading one byte beyond the end of the line

Problem:    Reading one byte beyond the end of the line.
Solution:   Check for NUL byte first.
---
 src/ex_docmd.c                 |  3 ++-
 src/testdir/test_vim9_func.vim | 11 +++++++++++
 src/version.c                  |  2 ++
 src/vim9compile.c              |  3 ++-
 4 files changed, 17 insertions(+), 2 deletions(-)

--- a/src/ex_docmd.c
+++ b/src/ex_docmd.c
@@ -3644,7 +3644,8 @@
 	}
 
 	// Check for "++nr" and "--nr".
-	if (p == eap->cmd && p[0] == p[1] && (*p == '+' || *p == '-'))
+	if (p == eap->cmd && p[0] != NUL && p[0] == p[1]
+						   && (*p == '+' || *p == '-'))
 	{
 	    eap->cmdidx = *p == '+' ? CMD_increment : CMD_decrement;
 	    return eap->cmd + 2;
--- a/src/testdir/test_vim9_func.vim
+++ b/src/testdir/test_vim9_func.vim
@@ -3537,6 +3537,17 @@
   unlet g:mydict
 enddef
 
+def Test_go_beyond_end_of_cmd()
+  # this was reading the byte after the end of the line
+  var lines =<< trim END
+    def F()
+      cal
+    enddef
+    defcompile
+  END
+  CheckScriptFailure(lines, 'E476:')
+enddef
+
 if has('python3')
   def Test_python3_heredoc()
     py3 << trim EOF
--- a/src/vim9compile.c
+++ b/src/vim9compile.c
@@ -2786,7 +2786,8 @@
 	cmd = ea.cmd;
 	if ((*cmd != '$' || starts_with_colon)
 		&& (starts_with_colon || !(*cmd == '\''
-		       || (cmd[0] == cmd[1] && (*cmd == '+' || *cmd == '-')))))
+		       || (cmd[0] != NUL && cmd[0] == cmd[1]
+					    && (*cmd == '+' || *cmd == '-')))))
 	{
 	    ea.cmd = skip_range(ea.cmd, TRUE, NULL);
 	    if (ea.cmd > cmd)
