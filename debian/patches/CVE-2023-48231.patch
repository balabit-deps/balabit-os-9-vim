From 25aabc2b8ee1e19ced6f4da9d866cf9378fc4c5a Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Tue, 14 Nov 2023 19:31:34 +0100
Subject: [PATCH] patch 9.0.2106: [security]: Use-after-free in win_close()

Problem:  [security]: Use-after-free in win_close()
Solution: Check window is valid, before accessing it

If the current window structure is no longer valid (because a previous
autocommand has already freed this window), fail and return before
attempting to set win->w_closing variable.

Add a test to trigger ASAN in CI

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/testdir/crash/poc1     | Bin 0 -> 3264 bytes
 src/testdir/test_crash.vim |  33 +++++++++++++++++++++++++++++++++
 src/version.c              |   2 ++
 src/window.c               |   2 ++
 4 files changed, 37 insertions(+)
 create mode 100644 src/testdir/crash/poc1

--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -4627,6 +4627,8 @@ static int included_patches[] =
 /**/
     2069,
 /**/
+    2106,
+/**/
     2068,
 /**/
     2067,
--- vim-8.2.3995.orig/src/window.c
+++ vim-8.2.3995/src/window.c
@@ -2572,6 +2572,8 @@ win_close(win_T *win, int free_buf)
 	    reset_VIsual_and_resel();	// stop Visual mode
 
 	    other_buffer = TRUE;
+	    if (!win_valid(win))
+		return FAIL;
 	    win->w_closing = TRUE;
 	    apply_autocmds(EVENT_BUFLEAVE, NULL, NULL, FALSE, curbuf);
 	    if (!win_valid(win))
