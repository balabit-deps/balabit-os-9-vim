From ee9166eb3b41846661a39b662dc7ebe8b5e15139 Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Sun, 3 Sep 2023 21:24:33 +0200
Subject: [PATCH] patch 9.0.1858: [security] heap use after free in
 ins_compl_get_exp()

Problem:  heap use after free in ins_compl_get_exp()
Solution: validate buffer before accessing it

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/insexpand.c                   |  2 +-
 src/testdir/crash/poc_tagfunc.vim |  6 ++++++
 src/testdir/test_crash.vim        | 10 ++++++++--
 src/version.c                     |  2 ++
 4 files changed, 17 insertions(+), 3 deletions(-)
 create mode 100644 src/testdir/crash/poc_tagfunc.vim

--- vim-8.2.3995.orig/src/insexpand.c
+++ vim-8.2.3995/src/insexpand.c
@@ -3725,7 +3725,7 @@ ins_compl_get_exp(pos_T *ini)
 	else
 	{
 	    // Mark a buffer scanned when it has been scanned completely
-	    if (type == 0 || type == CTRL_X_PATH_PATTERNS)
+	    if (buf_valid(st.ins_buf) && (type == 0 || type == CTRL_X_PATH_PATTERNS))
 		st.ins_buf->b_scanned = TRUE;
 
 	    compl_started = FALSE;
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -5051,6 +5051,8 @@ static int included_patches[] =
 /**/
     1858,
 /**/
+    1858,
+/**/
     1331,
 /**/
     1857,
