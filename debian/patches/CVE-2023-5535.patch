From 41e6f7d6ba67b61d911f9b1d76325cd79224753d Mon Sep 17 00:00:00 2001
From: Christian Brabandt <cb@256bit.org>
Date: Wed, 11 Oct 2023 21:08:13 +0200
Subject: [PATCH] patch 9.0.2010: [security] use-after-free from
 buf_contents_changed()

Problem:  [security] use-after-free from buf_contents_changed()
Solution: block autocommands

Signed-off-by: Christian Brabandt <cb@256bit.org>
---
 src/buffer.c                            |   5 +++++
 src/testdir/crash/editing_arg_idx_POC_1 | Bin 0 -> 398 bytes
 src/testdir/test_crash.vim              |   9 +++++++++
 src/version.c                           |   2 ++
 4 files changed, 16 insertions(+)
 create mode 100644 src/testdir/crash/editing_arg_idx_POC_1

--- vim-8.2.3995.orig/src/buffer.c
+++ vim-8.2.3995/src/buffer.c
@@ -5811,6 +5811,9 @@ buf_contents_changed(buf_T *buf)
     // set curwin/curbuf to buf and save a few things
     aucmd_prepbuf(&aco, newbuf);
 
+    // We don't want to trigger autocommands now, they may have nasty
+    // side-effects like wiping buffers
+    block_autocmds();
     if (ml_open(curbuf) == OK
 	    && readfile(buf->b_ffname, buf->b_fname,
 				  (linenr_T)0, (linenr_T)0, (linenr_T)MAXLNUM,
@@ -5836,6 +5839,8 @@ buf_contents_changed(buf_T *buf)
     if (curbuf != newbuf)	// safety check
 	wipe_buffer(newbuf, FALSE);
 
+    unblock_autocmds();
+
     return differ;
 }
 
--- vim-8.2.3995.orig/src/version.c
+++ vim-8.2.3995/src/version.c
@@ -4779,6 +4779,8 @@ static int included_patches[] =
 /**/
     1993,
 /**/
+    2010,
+/**/
     1992,
 /**/
     1991,
